# 原生學術代理人編輯系統 (Native Academic Agentic Editor) 技術架構與產品設計白皮書

**版本**：1.0
**目標平台**：macOS Sequoia / iOS 18+ (Apple Silicon)
**核心理念**：雙核驅動（Swift + Rust）、隱私優先（On-Device AI）、繁體中文學術原生

---

## 1. 執行摘要 (Executive Summary)

本專案旨在構建下一代學術寫作環境，解決傳統工具（Word/LaTeX）在「易用性」與「專業排版」之間的長期矛盾。透過深度整合 Apple Intelligence 與高效能 Rust 生態系，我們提出了一種 **「代理人輔助出版」（Agent-Assisted Publishing）** 範式。

系統不再是被動的文字處理器，而是一個主動的 **多代理人系統（Multi-Agent System）**：

* **寫作代理**：理解繁體中文學術語境，提供符合台灣/香港學術規範的潤飾。
* **排版代理**：利用 Typst 引擎即時生成出版級 PDF，並透過 UniFFI 橋接確保 iOS 端的極致效能。
* **引註代理**：基於 Hayagriva 與 CSL 標準，自動管理複雜的書目格式。

---

## 2. 系統核心架構：雙核驅動 (Dual-Core Architecture)

為了兼顧原生體驗與底層效能，系統採用分層異構設計。

### 2.1 Swift 核（大腦與介面層）

負責 UI 渲染、使用者意圖識別、以及與作業系統的深度整合。

* **技術選型**：SwiftUI, TextKit 2, Foundation Models Framework, App Intents.
* **關鍵職責**：
  * **UIWritingToolsCoordinator**：直接對接 iOS 18 系統級寫作工具，提供「原地重寫」與「風格轉換」功能 [1]。
  * **Agent Orchestrator (Swift Actor)**：作為狀態機，管理多個 AI Agent 的生命週期與任務分發，確保並發安全性 [2]。
  * **RAG 檢索增強**：利用 `NaturalLanguage` 框架進行本地文本的分塊（Chunking）與向量化，輔助 AI 理解長文檔上下文 [4]。

### 2.2 Rust 核（肌肉與執行層）

負責確定性的計算任務，確保數據處理的絕對正確與高效。

* **技術選型**：Rust, Typst, Hayagriva, UniFFI.
* **關鍵職責**：
  * **Typst 編譯引擎**：封裝為靜態庫（`.a` / `.xcframework`），透過自定義 `World` trait 實作「記憶體內虛擬檔案系統」，解決 iOS 沙盒限制與字體加載問題 [6]。
  * **Hayagriva 書目管理**：解析 BibTeX/RIS/CSL-JSON，處理 CSL 樣式渲染，彌補 Swift 生態在學術引用處理上的空白 [9]。
  * **Docx 匯出轉換**：利用 pandoc (WASM) 或 `docx-rs` 結合 `mathml2omml` 進行高保真格式轉換 [11]。

### 2.3 跨語言橋接 (The Bridge)

* **UniFFI**：自動生成 Swift 與 Rust 之間的 FFI 綁定代碼，處理複雜數據結構（如結構化引用數據）的序列化與傳遞，消除手寫 C-Bridge 的安全隱患 [13]。

---

## 3. Apple Intelligence 深度整合策略

### 3.1 基礎模型框架 (Foundation Models Framework)

利用裝置端模型（~3B 參數）實現零延遲、隱私保護的智能輔助。

* **結構化輸出 (Guided Generation)**：使用 `@Generable` 與 `@Guide` 宏，強制模型輸出符合預定義 Swift Struct 的 JSON 數據（例如：提取論文元數據），而非非結構化文本 [14]。

    ```swift
    @Generable struct CitationMetadata {
        @Guide(description: "論文的主要作者姓氏") var author: String
        @Guide(description: "出版年份") var year: Int
    }
    ```

* **工具調用 (Tool Calling)**：定義自定義 `Tool` 協議，讓 AI 能主動調用 Rust 核心功能。例如，當用戶輸入「幫我引用這篇論文」，模型會解析意圖並調用 Rust 的 `search_bibliography` 函數 [16]。

### 3.2 繁體中文學術優化 (TC Optimization)

針對通用模型在繁體中文學術用語上的弱點進行微調。

* **Prompt Engineering**：注入系統級指令（System Prompt），建立「台灣學術編輯」角色。
* **規則庫**：強制將 "Information" 譯為「資訊」而非「信息」，"Software" 譯為「軟體」而非「軟件」 [40]。
* **語氣控制**：使用 Few-Shot Prompting 範例，引導模型使用「本研究旨在...」等正式學術句型，避免口語化 [18]。
* **字體與排版**：
  * **螢幕閱讀**：在 UI 中使用 PingFang TC 的 Medium 字重以確保清晰度。
  * **PDF 輸出**：在 Rust/Typst 層嵌入 Noto Serif TC (思源宋體)，符合學術論文對襯線體的要求，並解決缺字（Tofu）問題 [20]。

---

## 4. 代理人工作流與 UI/UX 設計

採用 **「流體智能」(Fluid Intelligence)** 設計語言，將 AI 的介入視覺化且非侵入化。

### 4.1 編輯器互動：Gutter AI (溝槽互動)

參考 Cursor 與 JetBrains 的設計，利用編輯器左側的行號區（Gutter）作為 AI 建議的棲息地 [22]。

* **狀態指示**：當 AI 正在分析某段落或檢查引用格式時，Gutter 顯示微弱的呼吸燈光效（Apple Intelligence Glow） [24]。
* **差異比對 (Inline Diff)**：AI 的修改建議（如潤色、降重）不直接覆蓋原文，而是以 Diff View 形式展開，綠色表示新增，紅色表示刪除。用戶可透過 `Cmd+K` 或點擊按鈕逐條「接受」或「拒絕」 [26]。

### 4.2 雙視窗同步 (Synchronized Split View)

Markdown/Typst 原始碼 與 PDF 預覽 並排顯示。

* **同步捲動**：實作基於元素映射（Element Mapping）的演算法。當用戶在左側編輯第 3 章時，右側 PDF 自動捲動至對應位置。這需要在 Rust 編譯器中注入 Source Map 資訊回傳給 Swift 層 [28]。

### 4.3 隱私與透明度

* **Private Cloud Compute (PCC)**：對於超長文檔摘要等需雲端算力的任務，明確標示數據將透過 PCC 處理，並強調其「無狀態」（Stateless）與「可驗證」（Verifiable）特性，以符合 IRB 對研究數據的合規要求 [30]。

---

## 5. 關鍵功能實作細節

### 5.1 書目管理系統

* **數據結構**：內部統一使用 **CSL-JSON** 格式，這是 Zotero 與 Citation.js 的通用標準 [32]。
* **Zotero 橋接**：透過 App Intents 或本地 HTTP 請求（需配置 macOS Sandbox Entitlements `com.apple.security.network.client`）與 Zotero 的 Better BibTeX 插件通訊，實現「一鍵插入」 [33]。
* **Rust 解析**：使用 **Hayagriva** 處理 `.bib` 或 `.ris` 檔案匯入，效能遠優於 JS 方案 [9]。

### 5.2 文件匯出與格式相容

* **PDF**：由 Typst 直接生成，支援 CMYK 色彩空間與學術級排版。
* **Word (DOCX)**：
  * **文字與結構**：使用 `docx-rs` 生成段落、標題與表格 [11]。
  * **數學公式**：Typst 的數學語法需先轉換為 MathML，再利用 `mathml2omml` 庫轉換為 Word 原生的 OMML 格式，確保公式在 Word 中可編輯 [35]。
  * **後備方案**：對於極度複雜的佈局，提供將頁面渲染為高解析度圖片插入 Word 的選項。

### 5.3 效能優化 (8GB 記憶體挑戰)

* **按需加載**：Foundation Models 僅在需要時初始化 `LanguageModelSession`，閒置時釋放 [37]。
* **增量編譯**：Typst 的 `World` 實作必須支援緩存（Cache），僅重新編譯修改的部分，實現 <50ms 的預覽更新率 [38]。

---

## 6. 結論與展望

本計畫不僅是開發一款軟體，更是定義一種新的學術生產力標準。通過 Swift 帶來的原生流暢體驗、Apple Intelligence 提供的隱私保護智能、以及 Rust/Typst 構建的堅實排版地基，我們將為繁體中文學術界提供一把真正稱手的「數位利劍」。

### 下一步行動 (Immediate Next Steps)

1. **原型驗證 (PoC)**：搭建 Swift-Rust (UniFFI) 橋接，驗證在 iOS 上運行 Typst 編譯器的可行性。
2. **模型微調**：收集台灣學術論文摘要數據集，測試 Apple Foundation Models 的 Few-Shot 表現。
3. **UI 刻畫**：使用 SwiftUI 實作帶有 Gutter 互動的 TextKit 2 編輯器原型。

---

### 附錄：關鍵技術棧清單

* **Language**: Swift 6, Rust 1.80+
* **UI Framework**: SwiftUI, TextKit 2
* **AI Framework**: Foundation Models, Core ML
* **Rust Crates**: `typst`, `hayagriva`, `uniffi`, `docx-rs`, `mathml2omml`
* **Interoperability**: UniFFI
