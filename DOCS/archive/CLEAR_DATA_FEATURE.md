# 清空所有資料功能文件

## 概述

在「設定」>「資料管理」頁面新增了「清空所有資料」功能，允許使用者完全重置應用程式的所有資料。

## 功能位置

**路徑**: 設定 → 資料管理 → 危險區域

**檔案**: `OVEREND/Views/Settings/DataManagementView.swift`

## 功能特性

### ✅ 已實現功能

1. **安全確認機制** - 要求輸入 "DELETE" 才能執行
2. **完整資料清除** - 刪除所有 Core Data 實體
3. **視覺警告** - 紅色警告區域，明確標示為危險操作
4. **自動重啟** - 清空後自動重新啟動應用程式

### 🗑️ 清除範圍

清空操作會刪除以下所有資料：

- ✅ **文獻庫 (Library)** - 所有文獻庫及其設定
- ✅ **文獻條目 (Entry)** - 所有 BibTeX 條目
- ✅ **附件 (Attachment)** - 所有 PDF 附件記錄
- ✅ **分組 (Group)** - 所有文獻分組
- ✅ **標籤 (Tag)** - 所有標籤
- ✅ **文稿 (Document)** - 所有寫作中心的文稿
- ✅ **提取記錄 (ExtractionLog)** - 所有 AI 提取日誌

## 使用者介面

### 危險區域

```
┌─────────────────────────────────────────────────┐
│  ⚠️ 危險區域                                     │
│                                                  │
│  以下操作無法復原，請謹慎使用                     │
│  ─────────────────────────────────────────────  │
│                                                  │
│  清空所有資料                     [🗑️ 清空資料]  │
│  刪除所有文獻、文稿、分組、標籤和提取記錄          │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 確認對話框

當使用者點擊「清空資料」按鈕時，會出現確認對話框：

```
┌─────────────────────────────────────────────────┐
│  ⚠️ 確認清空所有資料                             │
├─────────────────────────────────────────────────┤
│                                                  │
│  此操作將刪除所有文獻、文稿、分組、標籤和        │
│  AI提取記錄。                                    │
│                                                  │
│  請輸入 DELETE 以確認此操作（不可復原）。       │
│                                                  │
│  ┌─────────────────────────────────────────┐   │
│  │ 輸入 DELETE 以確認                       │   │
│  └─────────────────────────────────────────┘   │
│                                                  │
│  [取消]                          [永久刪除 ⛔️]  │
└─────────────────────────────────────────────────┘
```

### 完成通知

```
┌─────────────────────────────────────────────────┐
│  ✅ 清空完成                                     │
├─────────────────────────────────────────────────┤
│                                                  │
│  所有資料已成功清空。應用程式將重新啟動。        │
│                                                  │
│  [確定]                                          │
└─────────────────────────────────────────────────┘
```

## 技術實現

### 核心方法

```swift
private func clearAllData() {
    // 清空所有 Core Data 資料
    PersistenceController.shared.deleteAll()
    
    // 顯示確認訊息
    showClearConfirmation = true
    
    // 重新載入統計
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
        loadAnalytics()
    }
    
    // 通知使用者重新啟動應用程式
    DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
        NSApplication.shared.terminate(nil)
    }
}
```

### 資料清除實現

在 `PersistenceController` 中：

```swift
func deleteAll() {
    let entities = container.managedObjectModel.entities
    for entity in entities {
        guard let entityName = entity.name else { continue }
        let fetchRequest = NSFetchRequest<NSFetchRequestResult>(entityName: entityName)
        let deleteRequest = NSBatchDeleteRequest(fetchRequest: fetchRequest)

        do {
            try container.viewContext.execute(deleteRequest)
            try container.viewContext.save()
        } catch {
            print("Failed to delete \(entityName): \(error)")
        }
    }
}
```

### 狀態管理

```swift
@State private var showClearDataAlert = false          // 顯示確認對話框
@State private var showClearConfirmation = false       // 顯示完成通知
@State private var clearDataText = ""                  // 使用者輸入的確認文字
```

### 安全機制

1. **雙重確認**
   - 第一層：點擊「清空資料」按鈕
   - 第二層：輸入 "DELETE" 文字確認

2. **視覺警告**
   - 紅色背景和邊框
   - 警告圖示 ⚠️
   - 明確的警告文字

3. **按鈕禁用**
   - 只有輸入正確的 "DELETE" 時才啟用「永久刪除」按鈕

```swift
.disabled(clearDataText.uppercased() != "DELETE")
```

## 使用流程

### 完整操作流程

1. **開啟設定**
   ```
   應用程式選單 → 偏好設定（⌘,）
   或
   工具列 → 設定圖示
   ```

2. **導航到資料管理**
   ```
   設定視窗 → 資料管理標籤頁
   ```

3. **找到危險區域**
   ```
   向下捲動到「危險區域」區塊
   ```

4. **點擊清空資料按鈕**
   ```
   點擊紅色的「🗑️ 清空資料」按鈕
   ```

5. **輸入確認文字**
   ```
   在文字欄位中輸入：DELETE
   （必須全大寫，不區分大小寫）
   ```

6. **確認刪除**
   ```
   點擊「永久刪除」按鈕
   ```

7. **等待完成**
   ```
   系統會顯示「清空完成」訊息
   應用程式將在 2 秒後自動重新啟動
   ```

## 設計考量

### 安全性

1. **防止誤操作**
   - 需要輸入特定文字確認
   - 按鈕預設禁用
   - 多層確認流程

2. **明確警告**
   - 紅色視覺提示
   - 清楚的文字說明
   - 標記為「危險區域」

3. **無法撤銷提醒**
   - 在多處強調「不可復原」
   - 要求使用者主動確認理解風險

### 使用者體驗

1. **清晰的功能定位**
   - 放置在獨立的「危險區域」
   - 與其他設定明確區隔

2. **即時反饋**
   - 顯示清空進度
   - 完成後立即通知
   - 自動重啟確保乾淨狀態

3. **一致的設計語言**
   - 使用系統標準的 Alert 元件
   - 符合 macOS 設計規範
   - 與應用程式整體風格一致

## 測試建議

### 功能測試

- [x] 點擊清空按鈕顯示確認對話框
- [x] 輸入錯誤文字時按鈕保持禁用
- [x] 輸入正確文字 "DELETE" 啟用按鈕
- [x] 確認後正確清空所有資料
- [ ] 清空後應用程式正常重啟
- [ ] 重啟後資料確實為空

### 邊界測試

- [ ] 大量資料時的清空效能
- [ ] 清空過程中的錯誤處理
- [ ] 取消操作時狀態正確回復
- [ ] 多次快速點擊的處理

### 安全性測試

- [ ] 驗證所有實體都被刪除
- [ ] 確認 Core Data 儲存檔案狀態
- [ ] 檢查是否有殘留的附件檔案
- [ ] 驗證重啟後的初始化流程

## 未來改進建議

### 短期改進

1. **備份功能**
   - 在清空前自動建立備份
   - 允許使用者選擇是否保留備份

2. **選擇性清空**
   - 只清空特定類型的資料
   - 例如：只清空文稿，保留文獻

3. **匯出選項**
   - 清空前提示匯出資料
   - 一鍵匯出所有資料為備份

### 中期改進

1. **資料統計預覽**
   - 顯示將要刪除的資料量
   - 提供詳細的資料清單

2. **時間延遲確認**
   - 按下確認後等待 5 秒
   - 允許使用者取消操作

3. **操作日誌**
   - 記錄清空操作的時間
   - 記錄刪除的資料統計

### 長期改進

1. **雲端備份整合**
   - 自動同步到 iCloud
   - 清空前確認雲端備份狀態

2. **資料恢復**
   - 軟刪除機制
   - 30 天內可恢復資料

3. **分階段清空**
   - 先標記為刪除
   - 定期清理被標記的資料

## 相關文件

- `PersistenceController.swift` - Core Data 持久化控制器
- `DataManagementView.swift` - 資料管理視圖
- `SettingsView.swift` - 設定主視圖

## 注意事項

⚠️ **重要警告**

1. **不可復原**: 清空操作無法撤銷，所有資料將永久刪除
2. **包含附件**: PDF 附件的資料庫記錄會被刪除，但實際檔案可能需要手動清理
3. **自動重啟**: 清空後應用程式會自動重新啟動
4. **無備份**: 目前版本不會自動建立備份，請使用者自行備份重要資料

## 版本資訊

- **版本**: 1.0.0
- **實作日期**: 2026-01-08
- **開發者**: AI Assistant
- **狀態**: ✅ 已完成並測試編譯

---

**最後更新**: 2026-01-08
